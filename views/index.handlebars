<!DOCTYPE html>
<html>

<head>
<title>Get Me There Index</title>
 <!-- Compiled and minified CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css">

  <!-- Compiled and minified JavaScript -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/js/materialize.min.js"></script>
<style>
     html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
      	width: 100%;
        height: 500px;
      }
      .nearby_ranks{
      	height: 100%;
      }
</style>
 
  
</head>

<body class='yellow'>

<div class='container'>
	<div class="row">

		
			
				<div class='blue darken-1 card-panel col m8 s12'>
					<h3 class='flow-text'>Let's Get You There ...</h3>  
					<p style='display:none;' id='latitude'></p>
					<p style='display:none;' id='longitude'></p>
				  	<div class="form-group col s12">
				    	<input type="text" class="white form-control " placeholder="Search Destination">
				  	</div>
				  	<br>
				  	<br>
				  	<input id="button" type="submit" class="btn yellow black-text"></button>
				  	<button id="button" type="submit" class="btn yellow black-text">Show More Ranks</button>
				  	<!-- <div id="floating-panel">
				    <b>Mode of Travel: </b>
				    <select id="mode">
				      <option value="DRIVING">Driving</option>
				      <option value="WALKING">Walking</option>
				      <option value="BICYCLING">Bicycling</option>
				      <option value="TRANSIT">Transit</option>
				    </select>
				    </div> -->
				    <div id="map" class='col s12'></div>
				</div>
			
	

				<div class="nearby_ranks yellow col s12 m4">
					<div class="container">
						<h2 class='flow-text'><b>Ranks Nearby</b></h2>
						<div id="ranks-near">
							{{#ranks}}
							<div class='collection-item'>
								<h5 class='flow-text'>{{name}}</h5>
							</div>
							{{/ranks}}
						</div>
					</div>
				</div>

	</div>
</div>

 <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script type="text/javascript">
	var ranks =[];
	function addRank(rankObj){
				console.log(rankObj)
				ranks.push(rankObj)
	}
	{{#ranks}}
	var rank = {}
	rank['id']={{rank_id}};
	rank['name'] = '{{name}}';
	rank['latitude']={{latitude}};
	rank['longitude']={{longitude}};
	rank['type']='{{type}}';
	addRank(rank)
	{{/ranks}}

		
    function initMap() {	 			
				navigator.geolocation.getCurrentPosition(function(location){
					var directionsDisplay = new google.maps.DirectionsRenderer({
						    polylineOptions: {
						      strokeColor: "red"
						    }
						  });
  					var directionsService = new google.maps.DirectionsService;
					var pinColor = "0000FF";
				    var pinImage = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|" + pinColor,
				        new google.maps.Size(21, 34),
				        new google.maps.Point(0,0),
				        new google.maps.Point(10, 34));
				    var pinShadow = new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_shadow",
				        new google.maps.Size(40, 37),
				        new google.maps.Point(0, 0),
				        new google.maps.Point(12, 35));

					document.getElementById('latitude').innerHTML = location.coords.latitude;
					document.getElementById('longitude').innerHTML = location.coords.longitude;
					var myLatLng = {
					  					lat: parseFloat(document.getElementById('latitude').innerHTML),
					  					lng: parseFloat(document.getElementById('longitude').innerHTML)
					  				 };
					  
					  var map = new google.maps.Map(document.getElementById('map'), {
					    zoom: 14
					    
					  });

					  directionsDisplay.setMap(map);

					 /* var marker = new google.maps.Marker({
					    position: myLatLng,
					    map: map,
					    title: 'You are here '
					  });*/

					 

					  ranks.forEach(function(rank){
					  	    rank['lat']=rank.latitude
					  	    rank['lng']=rank.longitude
					  	    if(ranks.indexOf(rank) == 0){
					  	    	calculateAndDisplayRoute(directionsService, directionsDisplay,rank);
					  	    }
					  	    else{

						  	   	var rank = new google.maps.Marker({
								    position: rank,
								    map: map,
								    title: rank.name,
								    icon: pinImage,
	                				shadow: pinShadow
								  });
						  	 }

					  })

					  function calculateAndDisplayRoute(directionsService, directionsDisplay,rank) {
						  
						  directionsService.route({
						    origin: {
						    	lat: parseFloat(document.getElementById('latitude').innerHTML),
						    	lng: parseFloat(document.getElementById('longitude').innerHTML)
						    },  
						    destination: {
						    	lat: rank.lat, 
						    	lng:rank.lng
						    },  
						    travelMode: google.maps.TravelMode['WALKING']
						  }, function(response, status) {
						    if (status == google.maps.DirectionsStatus.OK) {
						      directionsDisplay.setDirections(response);
						    } else {
						      window.alert('Directions request failed due to ' + status);
						    }
						  });
						}
					
				});
			}
			
    </script>

  <script async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsKNnCbz8sTyUC1_aPZsxN7iiGElykAS4&signed_in=false&callback=initMap"></script>
</body>
</html>
